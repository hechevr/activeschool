<!DOCTYPE html>
<html lang="en" >
<head>
    <meta charset="UTF-8">
    <title>Activity</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha/css/bootstrap.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha/js/bootstrap.min.js"></script>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.6/angular-route.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.6.1/angular-cookies.min.js"></script>
    
</head>

<body class="container-fluid">
    <div ng-app="userModel" ng-controller="itemlistController">
        <nav class="navbar navbar-light navbar-inverse bg-inverse">
          
          <button class="btn" style="font-weight: 700; float: right; background-color: transparent; border-color: #33a6cc; color:#33a6cc" ng-click="Logout()">Logout</button>
        </nav>
        <h1 style="font-weight:700" ng-bind="user.name"></h1>
  <table class="table table-bordered">
    <thead class="thead thead-inverse">
    <tr>
      <th>活動組織</th>
      <th>No.</th>
      <th>活動課程</th>
      <th>對象</th>
      <th>導師人數上限</th>
      <th>師生比例:學生人數上限</th>
      <th>日期</th>
      <th>備註</th>
    </tr>
    </thead>
    
    <tr class="table-active" ng-repeat-start="item in itemlist" ng-click="showdetail(item)">
      <td ng-bind="item.organization"></td>
      <td ng-bind="item.No"></td>
      <td ng-bind="item.activity"></td>
      <td ng-bind="item.target"></td>
      <td ng-bind="item.maxteacher"></td>
      <td ng-bind="item.ratio"></td>
      <td ng-bind="item.date"></td>
      <td ng-bind="item.options"></td>
    </tr>
    <tr ng-repeat-end ng-repeat="t in item.time">
        <td ng-bind="t.value" colspan='8'></td>
    </tr>
  </table>
  <textarea style="resize: none; width:100%" row="3" ng-bind="user.comment" readonly></textarea>
  <button class="btn btn-success" ng-click="Return()">Return</button>
</div>
  <script src='http://cdnjs.cloudflare.com/ajax/libs/respond.js/1.4.2/respond.js'></script>

  <script>
      var app = angular.module("userModel", ['ngCookies']);
      app.controller("itemlistController", function($scope, $http, $window, $cookies){
        var uid = location.search.substring(1);
        $scope.itemlist = [];
        $http.post("/admin/user/"+uid, [])
        .then(function(response) {
          if (response.data.feedback === 'Failure' || response.data.data === null) {
            $window.location.href = '/login.html';
          }
          console.log(response);
          $scope.user = response.data.data;

          $http.post("/itemlistdata", {})
          .then(function(response) {
              if (response.data.feedback === 'Failure') {
                  $window.location.href = '/login.html';
              }
              console.log(response);
              for (idx in response.data.itemlist) {
                response.data.itemlist[idx].show = false;
                var hasUser = false;
                var item = {
                  organization: response.data.itemlist[idx].organization,
                  No: response.data.itemlist[idx].No,
                  activity: response.data.itemlist[idx].activity,
                  target: response.data.itemlist[idx].target,
                  maxteacher: response.data.itemlist[idx].maxteacher,
                  ratio: response.data.itemlist[idx].ratio,
                  date: response.data.itemlist[idx].date,
                  options: response.data.itemlist[idx].options,
                  time:[]
                };
                for (t in response.data.itemlist[idx].time) {
                  if (response.data.itemlist[idx].time[t].user === uid) {
                    response.data.itemlist[idx].time[t].show = true;
                    hasUser = true;
                    item.time.push(response.data.itemlist[idx].time[t]);
                  }
                }
                if (hasUser) {
                  $scope.itemlist.push(item);
                }
              }
          });
        })
        
        $scope.showdetail = function(item) {
          item.show = !item.show
          console.log("show detail");
        }
        $scope.Return = function() {
          $window.location.href = '/admin.html';
        }
        $scope.Logout = function() {
          $http.post('/users/logout', {})
          .then(function logoutSuccess(response) {
            console.log(response);
            $cookies.remove('uid');
            $window.location.href = '/';
          });
        };
    });
  </script>
  
</body>
</html>
