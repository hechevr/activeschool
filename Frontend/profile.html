<!DOCTYPE html>
<html lang="en" >
<head>
    <meta charset="UTF-8">
    <title>Activity</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha/css/bootstrap.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha/js/bootstrap.min.js"></script>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">

    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.6/angular-route.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.6.1/angular-cookies.min.js"></script>

</head>

<body>
    <div ng-app="userModel" ng-controller="itemlistController">
        <nav class="navbar navbar-inverse bg-inverse">
            <div class="container-fluid">
                <div class="navbar-header"><a class="navbar-brand" href="#">ActiveSchool</a></div>
                <ul class="nav navbar-nav">
                    <li><a href="#" ng-click="showItemlist()">Activity list</a></li>
                    <li class="active"><a href="#" ng-click="showProfile()">My Selection</a></li>
                    <li><a href="#" ng-click="oldprofile={name:user.name};newprofile={};" data-toggle="modal" data-target="#myModal">Update Info</a></li>
                </ul>
                <div class="navbar-right">
                    <button class="btn" style="font-weight: 700; float: right; background-color: transparent; border-color: #33a6cc; color:#33a6cc" ng-click="Logout()">Logout</button>
                </div>
            </div>
        </nav>
        <div class="container-fluid">
            <h1 style="font-weight:700" ng-bind="user.name"></h1>

            <!-- Modal -->
            <div class="modal fade" id="myModal" role="dialog">
                <div class="modal-dialog">

                    <!-- Modal content-->
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                            <h4 class="modal-title">Update Profile</h4>
                        </div>
                        <div class="modal-body">
                            <form>
                                <div class="form-group">
                                    <label>Current info</label>
                                </div>
                                <div class="form-group">
                                    <input ng-model="oldprofile.name" placeholder="name" special-char-directive>
                                    <input type="email" ng-model="oldprofile.email" placeholder="email">
                                    <input ng-model="oldprofile.password" placeholder="password" special-char-directive>
                                </div>
                                <div class="form-group">
                                    <label>New info</label>
                                </div>
                                <div class="form-group">
                                    <input ng-model="newprofile.name" placeholder="name" special-char-directive>
                                    <input type="email" ng-model="newprofile.email" placeholder="email">
                                    <input ng-model="newprofile.password" placeholder="password" special-char-directive>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <p style="color:red" ng-show="showerror" ng-model="errormsg">Invalid input</p>
                            <button type="button" class="btn btn-success" ng-click="updateprofile()">Submit</button>
                            <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                        </div>
                    </div>

                </div>
            </div>


            <table class="table table-bordered">
                <thead class="thead thead-inverse">
                    <tr>
                        <th>活動組織</th>
                        <th>No.</th>
                        <th>活動課程</th>
                        <th>對象</th>
                        <th>導師人數上限</th>
                        <th>師生比例:學生人數上限</th>
                        <th>日期</th>
                        <th>備註</th>
                    </tr>
                </thead>

                <tr class="table-active" ng-repeat-start="item in itemlist">
                    <td ng-bind="item.organization"></td>
                    <td ng-bind="item.No"></td>
                    <td ng-bind="item.activity"></td>
                    <td ng-bind="item.target"></td>
                    <td ng-bind="item.maxteacher"></td>
                    <td ng-bind="item.ratio"></td>
                    <td ng-bind="item.date"></td>
                    <td ng-bind="item.options"></td>
                </tr>
                <tr ng-repeat-end ng-repeat="t in item.time">
                    <td ng-bind="t.value" colspan='8'></td>
                </tr>
            </table>
            <textarea style="resize: none; width:100%" row="3" ng-bind="user.comment" readonly></textarea>
            <button class="btn" style="background-color: transparent; border-color:black;" ng-click="cancel()">Return</button>
        </div>
    </div>
    <script src='http://cdnjs.cloudflare.com/ajax/libs/respond.js/1.4.2/respond.js'></script>

    <script>
    var app = angular.module("userModel", ['ngCookies']);
    app.controller("itemlistController", function($scope, $http, $window, $cookies){
        var uid = location.search.substring(1);
        $scope.itemlist = [];
        $http.post("/admin/user/detail/"+uid, [])
        .then(function(response) {
            if (response.data.feedback === 'Failure' || response.data.data === null) {
                $window.location.href = '/login.html';
            }
            console.log(response);
            $scope.user = response.data.data;

            $http.post("/itemlistdata", {})
            .then(function(response) {
                if (response.data.feedback === 'Failure') {
                    $window.location.href = '/login.html';
                }
                console.log(response);
                for (idx in response.data.itemlist) {
                    response.data.itemlist[idx].show = false;
                    var hasUser = false;

                    var item = {
                        organization: response.data.itemlist[idx].organization,
                        No: response.data.itemlist[idx].No,
                        activity: response.data.itemlist[idx].activity,
                        target: "",
                        maxteacher: response.data.itemlist[idx].maxteacher,
                        ratio: response.data.itemlist[idx].ratio,
                        date: "",
                        options: response.data.itemlist[idx].options,
                        time:[]
                    };
                    var targetlist = response.data.itemlist[idx].target.split(',');
                    var datelist = response.data.itemlist[idx].date.split(',');
                    item.target = targetTranslate(targetlist[0]) + "至" + targetTranslate(targetlist[1]);
                    for (ti in datelist) {
                        item.date += dateTranslate(datelist[ti]);
                        if (ti < datelist.length - 1) {
                            item.date += ",";
                        }

                    }
                    for (t in response.data.itemlist[idx].time) {
                        if (response.data.itemlist[idx].time[t].user === uid) {
                            response.data.itemlist[idx].time[t].show = true;
                            hasUser = true;
                            item.time.push(response.data.itemlist[idx].time[t]);
                        }
                    }
                    if (hasUser) {
                        $scope.itemlist.push(item);
                    }
                }
            });
        });
        const targetTranslate = function(target) {
            if (target === 'L1') {
                return "小一";
            }
            else if (target === "L2") {
                return "小二";
            }
            else if (target === "L3") {
                return "小三";
            }
            else if (target === "L4") {
                return "小四";
            }
            else if (target === "L5") {
                return "小五";
            }
            else if (target === "L6") {
                return "小六";
            }
            else if (target === "M1") {
                return "中一";
            }
            else if (target === "M2") {
                return "中二";
            }
            else if (target === "M3") {
                return "中三";
            }
            else if (target === "M4") {
                return "中四";
            }
            else if (target === "M5") {
                return "中五";
            }
            else if (target === "M6") {
                return "中六";
            }
            return target;
        }
        const dateTranslate = function(date) {
            if (date === "Mon") {
                return "星期一";
            }
            else if (date === "Tue") {
                return "星期二";
            }
            else if (date === "Wed") {
                return "星期三";
            }
            else if (date === "Thur") {
                return "星期四";
            }
            else if (date === "Fri") {
                return "星期五";
            }
            else if (date === "Sat") {
                return "星期六";
            }
            else if (date === "Sun") {
                return "星期日";
            }
            return date;
        }
        $scope.cancel = function() {
            $window.history.back();
        }
        $scope.showProfile = function() {
            $window.location.href = "/profile.html?"+uid;
        }
        $scope.showItemlist = function() {
            $window.location.href = "/itemlist.html";
        }
        $scope.updateprofile = function() {
            if ($scope.oldprofile.email != undefined && $scope.oldprofile.name != undefined && $scope.oldprofile.password != undefined && $scope.newprofile.email != undefined && $scope.newprofile.name != undefined && $scope.newprofile.password != undefined) {
                $http.post("/users/update/"+uid, {oldprofile:$scope.oldprofile, newprofile:$scope.newprofile})
                .then(function(response) {
                    console.log(response);
                    if (response.feedback === 'Success') {
                        $window.location.reload();
                    }
                    else {
                        $scope.showerror = true;
                        if (response.msg != undefined) {
                            $scope.errormsg = response.msg;
                        }
                        else {
                            console.log("wtf");
                            $scope.errormsg = "error";
                        }
                    }
                })
            }
            else {
                $scope.showerror = true;
                $scope.errormsg = "Invalid Input";
            }
        }
        $scope.Logout = function() {
            $http.post('/users/logout', {})
            .then(function logoutSuccess(response) {
                console.log(response);
                $cookies.remove('uid');
                $window.location.href = '/';
            });
        };
    })
    .directive('specialCharDirective', function() {
        function link(scope, elem, attrs, ngModel) {
            ngModel.$parsers.push(function(viewValue) {
                var reg = /^[a-zA-Z0-9]*$/;
                if (viewValue.match(reg)) {
                    return viewValue;
                }
                var transformedValue = ngModel.$modelValue;
                ngModel.$setViewValue(transformedValue);
                ngModel.$render();
                return transformedValue;
            });
        }

        return {
            restrict: 'A',
            require: 'ngModel',
            link: link
        };
    });
    </script>

</body>
</html>
