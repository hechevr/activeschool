<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Activity</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha/css/bootstrap.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha/js/bootstrap.min.js"></script>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">

    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.6/angular-route.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.6.1/angular-cookies.min.js"></script>

</head>

<body>
    <div ng-app="userModel" ng-controller="itemlistController">
        <nav class="navbar navbar-inverse bg-inverse navbar-fixed-top">
            <div class="container-fluid">
                <div class="navbar-header"><a class="navbar-brand" href="#">動感校園</a></div>
                <ul class="nav navbar-nav">
                    <li class="active"><a href="#" ng-click="showItemlist()">項目列表</a></li>
                    <li><a href="#" ng-click="showProfile()">已選項目</a></li>
                    <!--<li><a href="#" ng-click="oldprofile={name:user.name};newprofile={};showerror=false;" data-toggle="modal" data-target="#myModal">更新信息</a></li>-->
                    <li class="dropdown">
                        <a class="dropdown-toggle" data-toggle="dropdown" href="#">下载</a>
                        <ul class="dropdown-menu">
                            <li><a href="#" ng-click="download(1)" ng-bind="activedownload[0]"></a></li>
                            <li><a href="#" ng-click="download(2)" ng-bind="activedownload[1]"></a></li>
                            <li><a href="#" ng-click="download(3)" ng-bind="activedownload[2]"></a></li>
                            <li><a href="#" ng-click="download(4)" ng-bind="activedownload[3]"></a></li>
                        </ul>
                    </li>
                    <li><a href="/album.html">相冊</a></li>
                </ul>
                <div class="navbar-right">
                        <span ng-bind="selectedItem"></span>
                        <span>/</span>
                        <span ng-bind="activenumber"></span>
                    <button class="btn" style="font-weight: 700; float: right; background-color: transparent; border-color: #33a6cc; color:#33a6cc" ng-click="Logout()">登出</button>
                </div>
            </div>
        </nav>

        <!--
        <div class="modal fade" id="myModal" role="dialog">
            <div class="modal-dialog">

                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <h4 class="modal-title">更新信息</h4>
                    </div>
                    <div class="modal-body">
                        <form>
                            <div class="form-group">
                                <label>現在信息</label>
                            </div>
                            <div class="form-group">
                                <input type="email" ng-model="oldprofile.email" placeholder="電郵">
                                <input ng-model="oldprofile.password" placeholder="密碼" special-char-directive>
                            </div>
                            <div class="form-group">
                                <label>新信息</label>
                            </div>
                            <div class="form-group">
                                <input type="email" ng-model="newprofile.email" placeholder="電郵">
                                <input ng-model="newprofile.password" placeholder="密碼" special-char-directive>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <p style="color:red" ng-show="showerror" ng-model="errormsg">無效的輸入</p>
                        <button type="button" class="btn btn-success" ng-click="updateprofile()">提交</button>
                        <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    </div>
                </div>

            </div>
        </div>
    -->
        <div class="container-fluid" style="margin-top:100px">
            <h2 style="color:#33a6cc;">動感校園 <span style="color:Black" ng-bind="activetitle"> </span>活動 / 課程時間表

            </h2>
            <table class="table table-bordered" style="width:100%">
                <thead class="thead thead-inverse">
                    <tr>
                        <th>活動組織</th>
                        <th>No.</th>
                        <th>活動課程</th>
                        <th>對象</th>
                        <th>導師<br>人數上限</th>
                        <th>師生比例<br>學生人數上限</th>
                        <th>日期</th>
                        <th>備註</th>
                    </tr>
                </thead>

                <tr class="table-active" ng-repeat-start="item in itemlist" ng-click="showdetail(item)">
                    <td ng-bind="item.organization"></td>
                    <td ng-bind="item.No"></td>
                    <td ng-bind="item.activity"></td>
                    <td ng-bind="item.target" style="min-width:90px"></td>
                    <td ng-bind="item.maxteacher"></td>
                    <td ng-bind="item.ratio"></td>
                    <td ng-bind="item.date" style="max-width:120px"></td>
                    <td ng-bind="item.options" style="max-width:120px; word-wrap: break-word;"></td>
                </tr>
                <tr ng-repeat-end ng-repeat="t in item.time" ng-show="item.show && t.show">
                    <td><input type="checkbox" ng-model="t.checked" ng-show="t.show" ng-disabled="userstatus" ng-click="changeSelectedItem(t)"/></td>
                    <td colspan="8" ng-bind="t.value"></td>
                </tr>
            </table>

            <div>
                <textarea class="form-control" style="resize: none; width:100%" row="3" ng-model="comment" maxlength=300 ng-disabled="userstatus" special-char-directive></textarea>
            </div>
            <br>
            <div>
                <button class="btn" style="background-color: transparent; color: green; border-color: green;" ng-click="submit()" ng-disabled="userstatus">提交</button>
                <button class="btn" style="background-color: transparent; border-color:black;" ng-click="cancel()">取消</button>
                <label ng-show="userstatus">您已經提交過申請，如果需要更改請聯繫管理員。</label>
            </div>
        </div>
    </div>
    <script src='http://cdnjs.cloudflare.com/ajax/libs/respond.js/1.4.2/respond.js'></script>

    <script>
    var app = angular.module("userModel", ['ngCookies']);
    app.controller("itemlistController", function($scope, $http, $window, $cookies){
        var uid = $cookies.get("uid");
        $scope.isActive = true;
        $scope.userstatus = true;
        $scope.itemlist = [];
        $scope.comment = "";
        $scope.selectedItem = 0;
        $http.get('/title').then(function(response) {
            console.log(response);
            if (response.data.feedback === 'Success') {
                $scope.activetitle = response.data.value;
                $scope.activenumber = response.data.number;
                $scope.activedownload = response.data.download.split(',');
            }
            else {
                $scope.activetitle = "";
            }
        });
        $http.post("/itemlistdata", {})
        .then(function(response) {
            // console.log(response);
            if (response.data.feedback === 'Failure') {
                $window.location.href = '/login.html';
            }
            $scope.itemlist = response.data.itemlist;
            for (idx in $scope.itemlist) {
                $scope.itemlist[idx].show = false;
                for (t in $scope.itemlist[idx].time) {
                    if ($scope.itemlist[idx].time[t].user === uid) {
                        $scope.itemlist[idx].time[t].show = true;
                        $scope.itemlist[idx].time[t].checked = true;
                        $scope.selectedItem ++;
                    }
                    else if ($scope.itemlist[idx].time[t].user !== undefined && $scope.itemlist[idx].time[t].user != "") {
                        $scope.itemlist[idx].time[t].show = false;
                    }
                    else {
                        $scope.itemlist[idx].time[t].show = true;
                    }
                }
                if ($scope.itemlist[idx].options === 'NULL') {
                    $scope.itemlist[idx].options = "";
                }
            }
        });
        $http.post("/comment/"+uid, {})
        .then(function(response) {
            // console.log(response);
            $scope.comment = response.data.comment;
            $scope.email = response.data.email;
            $scope.userstatus = !(response.data.status === 'active');
        });
        $scope.showdetail = function(item) {
            item.show = !item.show
            // console.log("show detail");
        }
        $scope.changeSelectedItem = function(t) {
            if (t.checked) {
                $scope.selectedItem ++;
                if ($scope.selectedItem > $scope.activenumber) {
                    t.checked = false;
                    $scope.selectedItem --;
                    console.log(t);
                }
            }
            else {
                $scope.selectedItem --;
            }
        }
        $scope.cancel = function() {
            $window.location.href = "/";
        }
        $scope.submit = function() {
            // console.log("click submit");
            var items = [];
            for (i in $scope.itemlist) {
                var item = $scope.itemlist[i];
                var time = [];
                var selected = false;
                for (t in item.time) {
                    if (item.time[t].checked && item.time[t].user !== uid) {
                        item.time[t].user = uid;
                        selected = true;
                    }
                    else if (!item.time[t].checked && item.time[t].user === uid) {
                        item.time[t].user = "";
                        selected = true;
                    }
                    time.push({value: item.time[t].value, user: item.time[t].user});
                }
                if (selected) {
                    items.push({_id: item._id, time});
                }
            }
            // console.log($scope.comment);
            $http.post('/selection/'+uid, {items:items, comment: $scope.comment, email: $scope.email})
            .then(function(response) {
                // console.log(response);
                if (response.data.feedback === 'Success') {
                    $window.location.href = '/itemlist.html';
                }
                else {
                    // console.log('Fail');
                }
            })
        };
        $scope.showProfile = function() {
            $window.location.href = "/profile.html?"+uid;
        }
        $scope.showItemlist = function() {
            $window.location.href = "/itemlist.html";
        }
        $scope.Logout = function() {
            $http.post('/users/logout', {})
            .then(function logoutSuccess(response) {
                // console.log(response);
                $cookies.remove('uid');
                $window.location.href = '/';
            });
        };
        /*
        $scope.updateprofile = function() {
            if ($scope.oldprofile.email != undefined && $scope.oldprofile.password != undefined && $scope.newprofile.email != undefined && $scope.newprofile.password != undefined) {
                $http.post("/users/update/"+uid, {oldprofile:$scope.oldprofile, newprofile:$scope.newprofile})
                .then(function(response) {
                    // console.log(response);
                    if (response.data.feedback === 'Success') {
                        $window.location.reload();
                    }
                    else {
                        $scope.showerror = true;
                        if (response.data.msg != undefined) {
                            $scope.errormsg = response.data.msg;
                        }
                        else {
                            $scope.errormsg = "error";
                        }
                    }
                })
            }
            else {
                $scope.showerror = true;
                $scope.errormsg = "Invalid Input";
            }
        }
        */
        $scope.download = function(index) {
            if (index === 1) {
                $window.open("/resourcenew/application.pdf");
            }
            else if (index == 2) {
                $window.open("/resourcenew/letter.pdf");
            }
            else if (index == 3) {
                $window.open("/resourcenew/info.pdf")
            }
            else if (index == 4) {
                $window.open("/resourcenew/timetable.pdf")
            }
        }
    })
    .directive('specialCharDirective', function() {
        function link(scope, elem, attrs, ngModel) {
            ngModel.$parsers.push(function(viewValue) {
                var reg = /^[a-zA-Z0-9-:,.，。（） \u4E00-\u9FCC]*$/;
                if (viewValue.match(reg)) {
                    return viewValue;
                }
                var transformedValue = ngModel.$modelValue;
                ngModel.$setViewValue(transformedValue);
                ngModel.$render();
                return transformedValue;
            });
        }
        return {
            restrict: 'A',
            require: 'ngModel',
            link: link
        };
    });
    </script>
</body>
</html>
