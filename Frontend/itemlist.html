<!DOCTYPE html>
<html lang="en" >
<head>
    <meta charset="UTF-8">
    <title>Activity</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">

    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.6/angular-route.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.6.1/angular-cookies.min.js"></script>
    
    <link rel="stylesheet" href="./css/style.css" type="text/css">

</head>

<body>
  <h1>動感校園 <span> 2017/18 (2017年10月9日至2018年2月23日) </span>活動 / 課程時間表</h1>
<div ng-app="userModel" ng-controller="itemlistController">
  <table class="responstable">
    
    <tr>
      <th>活動組織</th>
      <th>No.</th>
      <th>活動課程</th>
      <th>對象</th>
      <th>導師人數上限</th>
      <th>師生比例:學生人數上限</th>
      <th>日期</th>
      <th>備註</th>
    </tr>
    
    <tr ng-repeat-start="item in itemlist" ng-click="showdetail(item)">
      <td ng-bind="item.organization"></td>
      <td ng-bind="item.No"></td>
      <td ng-bind="item.activity"></td>
      <td ng-bind="item.target"></td>
      <td ng-bind="item.maxteacher"></td>
      <td ng-bind="item.ratio"></td>
      <td ng-bind="item.date"></td>
      <td ng-bind="item.options"></td>
    </tr>
    <tr ng-repeat-end ng-repeat="t in item.time" ng-show="item.show">
        <td><input type="checkbox" ng-model="t.checked" ng-show="t.show"/></td>
        <td colspan="7" ng-bind="t.value"></td>
    </tr>
  </table>

  <div>
    <textarea class="form-control" style="resize: none; width:100%" row="3" ng-model="comment" special-char-directive></textarea>
  </div>
  <button class="btn btn-success" ng-click="submit()">Submit</button>
  <button class="btn btn-default" ng-click="cancel()">Cancel</button>
</div>
  <script src='http://cdnjs.cloudflare.com/ajax/libs/respond.js/1.4.2/respond.js'></script>

  <script>
      var app = angular.module("userModel", ['ngCookies']);
      app.controller("itemlistController", function($scope, $http, $window, $cookies){
        var uid = $cookies.get("uid");
        $scope.itemlist = [];
        $http.post("/itemlistdata", {})
        .then(function(response) {
            console.log(response);
            $scope.itemlist = response.data.itemlist;
            for (idx in $scope.itemlist) {
              $scope.itemlist[idx].show = false;
              for (t in $scope.itemlist[idx].time) {
                if ($scope.itemlist[idx].time[t].user === uid) {
                  $scope.itemlist[idx].time[t].show = true;
                  $scope.itemlist[idx].time[t].checked = true;
                }
                else if ($scope.itemlist[idx].time[t].user !== undefined && $scope.itemlist[idx].time[t].user != "") {
                  $scope.itemlist[idx].time[t].show = false;
                }
                else {
                  $scope.itemlist[idx].time[t].show = true;
                }
              }
            }
        });
        $http.post("/comment/"+uid, {})
        .then(function(response) {
          console.log(response);
          $scope.comment = response.data.comment;
        });
        $scope.showdetail = function(item) {
          item.show = !item.show
          console.log("show detail");
        }
        $scope.cancel = function() {
          $window.location.href = "/";
        }
        $scope.submit = function() {
          console.log("click submit");
          var items = [];
          for (i in $scope.itemlist) {
            var item = $scope.itemlist[i];
            var time = [];
            var selected = false;
            for (t in item.time) {
              if (item.time[t].checked && item.time[t].user !== uid) {
                item.time[t].user = uid;
                selected = true;
              }
              else if (!item.time[t].checked && item.time[t].user === uid) {
                item.time[t].user = "";
                selected = true;
              }
              time.push({value: item.time[t].value, user: item.time[t].user});
            }
            if (selected) {
              items.push({_id: item._id, time});
            }
          }
          $http.post('/selection/'+uid, {items:items, comment: $scope.comment})
          .then(function(response) {
            console.log(response);
            if (response.data.feedback === 'Success') {
              $window.location.href = '/itemlist.html';
            }
            else {
              console.log('Fail');
            }
          })
        }
      })
      .directive('specialCharDirective', function() {
      function link(scope, elem, attrs, ngModel) {
          ngModel.$parsers.push(function(viewValue) {
              var reg = /^[a-zA-Z0-9-:,.]*$/;
              if (viewValue.match(reg)) {
                  return viewValue;
              }
              var transformedValue = ngModel.$modelValue;
              ngModel.$setViewValue(transformedValue);
              ngModel.$render();
              return transformedValue;
          });
        }
        return {
            restrict: 'A',
            require: 'ngModel',
            link: link
        };
      });
  </script>
  
</body>
</html>
